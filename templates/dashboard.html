{% extends "base.html" %}

{% block title %}Dashboard - YouTube Content Automation{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<section class="py-4 bg-white border-bottom">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="mb-1 text-dark">
                    <i class="fas fa-tachometer-alt"></i> 
                    Content Dashboard
                </h1>
                <p class="text-secondary mb-0">
                    {% if current_channel %}
                        <i class="fas fa-tv text-primary"></i> 
                        {{ current_channel.channel_name }}
                    {% else %}
                        Theo dõi tiến trình tạo nội dung YouTube
                    {% endif %}
                </p>
            </div>
            <div class="col-md-6 text-md-end">
                <div class="d-flex gap-2 justify-content-md-end align-items-center flex-wrap">
                    <!-- Channel Filter -->
                    <div class="dropdown channel-filter-dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" id="channelFilter" data-bs-toggle="dropdown">
                            <i class="fas fa-filter"></i> 
                            {% if current_channel %}
                                {{ current_channel.channel_name }}
                            {% else %}
                                Tất cả kênh
                            {% endif %}
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/dashboard">
                                <i class="fas fa-th-large"></i> Tất cả kênh
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            {% for channel in all_channels.values() %}
                            <li><a class="dropdown-item" href="/dashboard?channel_id={{ channel.channel_id }}">
                                <i class="fas fa-tv"></i> {{ channel.channel_name }}
                            </a></li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                <div class="badge bg-primary fs-6">
                    <i class="fas fa-boxes"></i> 
                        {{ packages|length }} Package{{ 's' if packages|length != 1 else '' }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Channel Statistics -->
{% if channel_stats %}
<section class="py-3 bg-light">
    <div class="container">
        <div class="row">
            {% for channel_id, stats in channel_stats.items() %}
                         <div class="col-md-2 col-sm-4 col-6 mb-2">
                 <div class="card text-center h-100 channel-stats-card">
                     <div class="card-body py-2">
                        <div class="small text-muted">{{ all_channels[channel_id].channel_name if channel_id in all_channels else channel_id }}</div>
                        <div class="h5 mb-0 text-primary">{{ stats.total_packages }}</div>
                        <div class="small text-success">{{ stats.completed_packages }} hoàn thành</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Dashboard Actions -->
<section class="py-3 bg-secondary">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-success btn-sm" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    
                    <button class="btn btn-primary btn-sm" onclick="window.location.href='/'">
                        <i class="fas fa-plus"></i> Tạo Mới
                    </button>
                    
                    <div class="ms-auto">
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> 
                            Auto-refresh sau 30s
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Packages Grid -->
<section class="py-4">
    <div class="container">
        {% if packages %}
            {% if not current_channel %}
                <!-- Group by Channel when showing all -->
                {% set packages_by_channel = {} %}
                {% for package in packages %}
                    {% set channel_id = package.channel_id %}
                    {% if channel_id not in packages_by_channel %}
                        {% set _ = packages_by_channel.update({channel_id: []}) %}
                    {% endif %}
                    {% set _ = packages_by_channel[channel_id].append(package) %}
                {% endfor %}
                
                                 {% for channel_id, channel_packages in packages_by_channel.items() %}
                <div class="mb-5 channel-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="text-primary channel-header">
                            <i class="fas fa-tv"></i> 
                            {{ all_channels[channel_id].channel_name if channel_id in all_channels else channel_id }}
                            <span class="badge bg-secondary ms-2">{{ channel_packages|length }}</span>
                        </h4>
                        <a href="/dashboard?channel_id={{ channel_id }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> Xem tất cả
                        </a>
                    </div>
                    
                    <div class="row">
                        {% for package in channel_packages %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card h-100" id="package-card-{{ package.id }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 package-channel-name">
                                    <i class="fas fa-tv text-primary"></i> 
                                    {{ package.channel_name }}
                                </h6>
                                <small class="text-muted package-id">{{ package.id }}</small>
                            </div>
                            <span class="badge status-badge status-{{ package.status }} package-status">
                                {{ package.status.upper() }}
                            </span>
                        </div>
                        
                        <div class="card-body">
                            <!-- Thumbnail Preview Container -->
                            <div class="thumbnail-container text-center mb-3 position-relative">
                                {% if package.input_data.video_frame_url %}
                                <img src="{{ package.input_data.video_frame_url }}" 
                                     alt="Reference Frame" 
                                     class="thumbnail-preview"
                                     title="Ảnh tham khảo">
                                <div class="position-absolute top-0 end-0 bg-info text-white px-1 rounded" 
                                     style="font-size: 0.7rem; margin: 2px;">
                                    <i class="fas fa-upload"></i> Ref
                                </div>
                                {% elif package.generated_images and package.generated_images.thumbnail_url %}
                                <img src="{{ package.generated_images.thumbnail_url }}" 
                                     alt="Generated Thumbnail" 
                                     class="thumbnail-preview"
                                     title="Ảnh được tạo">
                                <div class="position-absolute top-0 end-0 bg-success text-white px-1 rounded" 
                                     style="font-size: 0.7rem; margin: 2px;">
                                    <i class="fas fa-magic"></i> AI
                                </div>
                                {% else %}
                                <div class="bg-dark rounded d-flex align-items-center justify-content-center" 
                                     style="height: 85px; max-width: 150px; margin: 0 auto;">
                                    <i class="fas fa-image fa-2x text-muted"></i>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Title -->
                            <h6 class="card-title package-title">
                                {% if package.generated_content and package.generated_content.title and package.generated_content.title != "Đang tạo..." %}
                                    {{ package.generated_content.title[:60] }}{% if package.generated_content.title|length > 60 %}...{% endif %}
                                {% else %}
                                    <span class="text-muted">
                                        {{ package.input_data.video_topic or package.id }}
                                    </span>
                                {% endif %}
                            </h6>
                            
                            <!-- Timestamps -->
                            <div class="small text-muted mb-3 package-created-at">
                                <div>
                                    <i class="fas fa-calendar"></i> 
                                    {{ package.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                </div>
                            </div>
                            
                            <!-- Status Progress -->
                            <div class="mb-3 package-progress-container">
                                {% set progress_map = {
                                    'pending': 0,
                                    'processing': 25,
                                    'generating_content': 50,
                                    'generated': 100,
                                    'failed': 100 
                                } %}
                                {% set progress = progress_map.get(package.status.value, 0) %}
                                
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar" 
                                         role="progressbar"
                                         style="width: {{ progress }}%;"
                                         aria-valuenow="{{ progress }}"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                    </div>
                                </div>
                                <small class="text-muted package-status-text">
                                    {{ package.status.value.replace('_', ' ')|title }}
                                </small>
                            </div>
                        </div>
                        
                        <div class="card-footer">
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary flex-fill" 
                                        onclick="viewPackageDetails('{{ package.id }}')">
                                    <i class="fas fa-eye"></i> Chi tiết
                                </button>
                            </div>
                            
                            <!-- Recent Logs -->
                            <div class="mt-2 package-logs-container" style="max-height: 60px; overflow-y: auto;">
                                {% if package.processing_logs %}
                                <small class="text-muted">Logs gần nhất:</small>
                                <div class="mt-1">
                                    {% for log in package.processing_logs[-2:] %}
                                    <div class="small text-muted">
                                        <i class="fas fa-chevron-right"></i> 
                                        {{ log.split(': ', 1)[1] if ': ' in log else log }}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- Single Channel View -->
                <div class="row">
                    {% for package in packages %}
                    <div class="col-lg-6 col-xl-4 mb-4">
                        <div class="card h-100" id="package-card-{{ package.id }}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0 package-channel-name">
                                        <i class="fas fa-tv text-primary"></i> 
                                        {{ package.channel_name }}
                                    </h6>
                                    <small class="text-muted package-id">{{ package.id }}</small>
                                </div>
                                <span class="badge status-badge status-{{ package.status }} package-status">
                                    {{ package.status.upper() }}
                                </span>
                            </div>
                            
                            <div class="card-body">
                                <!-- Thumbnail Preview Container -->
                                <div class="thumbnail-container text-center mb-3 position-relative">
                                    {% if package.input_data.video_frame_url %}
                                    <img src="{{ package.input_data.video_frame_url }}" 
                                         alt="Reference Frame" 
                                         class="thumbnail-preview"
                                         title="Ảnh tham khảo">
                                    <div class="position-absolute top-0 end-0 bg-info text-white px-1 rounded" 
                                         style="font-size: 0.7rem; margin: 2px;">
                                        <i class="fas fa-upload"></i> Ref
                                    </div>
                                    {% elif package.generated_images and package.generated_images.thumbnail_url %}
                                    <img src="{{ package.generated_images.thumbnail_url }}" 
                                         alt="Generated Thumbnail" 
                                         class="thumbnail-preview"
                                         title="Ảnh được tạo">
                                    <div class="position-absolute top-0 end-0 bg-success text-white px-1 rounded" 
                                         style="font-size: 0.7rem; margin: 2px;">
                                        <i class="fas fa-magic"></i> AI
                                    </div>
                                    {% else %}
                                    <div class="bg-dark rounded d-flex align-items-center justify-content-center" 
                                         style="height: 85px; max-width: 150px; margin: 0 auto;">
                                        <i class="fas fa-image fa-2x text-muted"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Title -->
                                <h6 class="card-title package-title">
                                    {% if package.generated_content and package.generated_content.title and package.generated_content.title != "Đang tạo..." %}
                                        {{ package.generated_content.title[:60] }}{% if package.generated_content.title|length > 60 %}...{% endif %}
                                    {% else %}
                                        <span class="text-muted">
                                            {{ package.input_data.video_topic or package.id }}
                                        </span>
                                    {% endif %}
                                </h6>
                                
                                <!-- Timestamps -->
                                <div class="small text-muted mb-3 package-created-at">
                                    <div>
                                        <i class="fas fa-calendar"></i> 
                                        {{ package.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                    </div>
                                </div>
                                
                                <!-- Status Progress -->
                                <div class="mb-3 package-progress-container">
                                    {% set progress_map = {
                                        'pending': 0,
                                        'processing': 25,
                                        'generating_content': 50,
                                        'generated': 100,
                                        'failed': 100 
                                    } %}
                                    {% set progress = progress_map.get(package.status.value, 0) %}
                                    
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar" 
                                             role="progressbar"
                                             style="width: {{ progress }}%;"
                                             aria-valuenow="{{ progress }}"
                                             aria-valuemin="0"
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                    <small class="text-muted package-status-text">
                                        {{ package.status.value.replace('_', ' ')|title }}
                                    </small>
                                </div>
                            </div>
                            
                            <div class="card-footer">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary flex-fill" 
                                            onclick="viewPackageDetails('{{ package.id }}')">
                                        <i class="fas fa-eye"></i> Chi tiết
                                    </button>
                                </div>
                                
                                <!-- Recent Logs -->
                                <div class="mt-2 package-logs-container" style="max-height: 60px; overflow-y: auto;">
                                    {% if package.processing_logs %}
                                    <small class="text-muted">Logs gần nhất:</small>
                                    <div class="mt-1">
                                        {% for log in package.processing_logs[-2:] %}
                                        <div class="small text-muted">
                                            <i class="fas fa-chevron-right"></i> 
                                            {{ log.split(': ', 1)[1] if ': ' in log else log }}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-box-open fa-3x text-muted"></i>
                <h4 class="mt-3">Không có package nào</h4>
                <p class="text-muted">
                    Bắt đầu bằng cách <a href="/">tạo một nội dung mới</a>.
                </p>
            </div>
        {% endif %}
    </div>
</section>

<!-- Package Detail Modal -->
<div class="modal fade" id="packageDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết Package</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="packageDetailBody">
                <!-- Content will be loaded here via JS -->
                 <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
             <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="refreshPackageDetail()">
                    <i class="fas fa-sync-alt"></i> Làm mới
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentPackageId = null;

    function viewPackageDetails(packageId) {
        currentPackageId = packageId;
        const modal = new bootstrap.Modal(document.getElementById('packageDetailModal'));
        modal.show();
        refreshPackageDetail();
    }
    
    async function refreshPackageDetail() {
        if (!currentPackageId) return;
        
        const detailBody = document.getElementById('packageDetailBody');
        detailBody.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>`;

        try {
            const response = await fetch(`/api/package/${currentPackageId}`);
            if (!response.ok) {
                detailBody.innerHTML = `<div class="alert alert-danger">Lỗi khi tải dữ liệu.</div>`;
                return;
            }
            const data = await response.json();
            renderPackageDetail(data);
        } catch (error) {
            detailBody.innerHTML = `<div class="alert alert-danger">Lỗi kết nối.</div>`;
        }
    }

    function renderPackageDetail(data) {
        const detailBody = document.getElementById('packageDetailBody');
        
        // Image display logic
        let imageHtml = '';
        if (data.input_data && data.input_data.video_frame_url) {
            imageHtml = `
                <div class="mb-3 text-center">
                    <h6 class="text-muted">Ảnh tham khảo</h6>
                    <img src="${data.input_data.video_frame_url}" class="img-fluid rounded" style="max-height: 200px;">
                </div>`;
        } else if (data.generated_images && data.generated_images.thumbnail_url) {
            imageHtml = `
                <div class="mb-3 text-center">
                    <h6 class="text-muted">Thumbnail được tạo</h6>
                    <img src="${data.generated_images.thumbnail_url}" class="img-fluid rounded" style="max-height: 200px;">
                </div>`;
        }

        // Midjourney images selection
        let midjourneyHtml = '';
        if (data.generated_images && data.generated_images.midjourney_urls && data.generated_images.midjourney_urls.length > 0) {
            const images = data.generated_images.midjourney_urls.map(url => `
                <div class="col-6 col-md-3 mb-2">
                    <img src="${url}" class="img-fluid rounded border selectable-image"
                         onclick="selectImage('${data.id}', this, '${url}')"
                         ${data.generated_images.selected_image_url === url ? 'style="border: 3px solid #0d6efd !important;"' : ''}>
                </div>
            `).join('');
            
            midjourneyHtml = `
                <div class="mt-4">
                    <h6 class="text-muted">Chọn ảnh từ Midjourney (4)</h6>
                    <div class="row">${images}</div>
                </div>`;
        }

        const logsHtml = data.processing_logs.map(log => `<div><small class="text-muted">${log}</small></div>`).join('');

        detailBody.innerHTML = `
            <h5>${(data.generated_content && data.generated_content.title) || data.input_data.video_topic}</h5>
            <p><strong>Package ID:</strong> ${data.id}</p>
            <p><strong>Trạng thái:</strong> <span class="badge bg-primary">${data.status}</span></p>
            
            ${imageHtml}
            ${midjourneyHtml}

            <div class="mt-4">
                <h6 class="text-muted">Thông tin đã tạo</h6>
                <ul class="list-group">
                    <li class="list-group-item"><strong>Tiêu đề:</strong> ${(data.generated_content && data.generated_content.title) || 'N/A'}</li>
                    <li class="list-group-item"><strong>Mô tả:</strong><br><small>${(data.generated_content && data.generated_content.description) || 'N/A'}</small></li>
                    <li class="list-group-item"><strong>Tags:</strong> ${(data.generated_content && data.generated_content.tags.join(', ')) || 'N/A'}</li>
                </ul>
            </div>
            
            <div class="mt-4">
                <h6 class="text-muted">Logs</h6>
                <div class="log-box">${logsHtml}</div>
            </div>
        `;
    }

    async function selectImage(packageId, element, imageUrl) {
        // Remove selection from others
        document.querySelectorAll('.selectable-image').forEach(img => img.style.border = '1px solid #dee2e6');
        // Highlight selected
        element.style.border = '3px solid #0d6efd !important;';

        try {
            await fetch(`/api/packages/${packageId}/select-image`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({selected_image_url: imageUrl})
            });
        } catch (error) {
            console.error('Lỗi khi chọn ảnh:', error);
        }
    }
    
    function refreshDashboard() {
        // Simple reload for now
        window.location.reload();
    }

    function updateCard(packageData) {
        const card = document.getElementById(`package-card-${packageData.package_id}`);
        if (!card) return;

        // Update status badge
        const statusBadge = card.querySelector('.package-status');
        statusBadge.textContent = packageData.status.toUpperCase();
        statusBadge.className = `badge status-badge status-${packageData.status}`;

        // Update title
        const titleEl = card.querySelector('.package-title');
        titleEl.innerHTML = packageData.title ? `${packageData.title.substring(0,60)}...` : `<span class="text-muted">${packageData.package_id}</span>`;

        // Update progress bar
        const progressMap = {'pending': 0, 'processing': 25, 'generating_content': 50, 'generated': 100, 'failed': 100};
        const progress = progressMap[packageData.status] || 0;
        const progressBar = card.querySelector('.progress-bar');
        progressBar.style.width = `${progress}%`;
        
        const statusText = card.querySelector('.package-status-text');
        statusText.textContent = packageData.status.replace('_', ' ')|title;

        // Update thumbnail
        const thumbnailContainer = card.querySelector('.thumbnail-container');
        let thumbnailHtml = '';
        if (packageData.video_frame_url) {
            thumbnailHtml = `
                <img src="${packageData.video_frame_url}" alt="Reference Frame" class="thumbnail-preview" title="Ảnh tham khảo">
                <div class="position-absolute top-0 end-0 bg-info text-white px-1 rounded" style="font-size: 0.7rem; margin: 2px;">
                    <i class="fas fa-upload"></i> Ref
                </div>`;
        } else if (packageData.thumbnail_url) {
            thumbnailHtml = `
                <img src="${packageData.thumbnail_url}" alt="Generated Thumbnail" class="thumbnail-preview" title="Ảnh được tạo">
                <div class="position-absolute top-0 end-0 bg-success text-white px-1 rounded" style="font-size: 0.7rem; margin: 2px;">
                    <i class="fas fa-magic"></i> AI
                </div>`;
        } else {
            thumbnailHtml = `
                <div class="bg-dark rounded d-flex align-items-center justify-content-center" style="height: 85px; max-width: 150px; margin: 0 auto;">
                    <i class="fas fa-image fa-2x text-muted"></i>
                </div>`;
        }
        thumbnailContainer.innerHTML = thumbnailHtml;

        // Update logs
        const logsContainer = card.querySelector('.package-logs-container');
        if (packageData.logs && packageData.logs.length > 0) {
            const logsHtml = packageData.logs.map(log => 
                `<div class="small text-muted"><i class="fas fa-chevron-right"></i> ${log.split(': ')[1] || log}</div>`
            ).join('');
            logsContainer.innerHTML = `<small class="text-muted">Logs gần nhất:</small><div class="mt-1">${logsHtml}</div>`;
        }
    }

    async function pollPackageUpdates() {
        try {
            const response = await fetch('/api/packages');
            if (!response.ok) return;

            const data = await response.json();
            if (data.packages) {
                data.packages.forEach(pkg => updateCard(pkg));
            }
        } catch (error) {
            console.error("Lỗi khi lấy cập nhật packages:", error);
        }
    }

    // Initial poll and set interval
    pollPackageUpdates();
    setInterval(pollPackageUpdates, 15000); // Poll every 15 seconds

</script>
{% endblock %} 