{% extends "base.html" %}

{% block title %}Dashboard - YouTube Content Automation{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<section class="py-4 bg-white border-bottom">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="mb-1 text-dark">
                    <i class="fas fa-tachometer-alt"></i> 
                    Content Dashboard
                </h1>
                <p class="text-secondary mb-0">
                    {% if current_channel %}
                        <i class="fas fa-tv text-primary"></i> 
                        {{ current_channel.channel_name }}
                    {% else %}
                        Theo dõi tiến trình tạo nội dung YouTube
                    {% endif %}
                </p>
            </div>
            <div class="col-md-6 text-md-end">
                <div class="d-flex gap-2 justify-content-md-end align-items-center flex-wrap">
                    <!-- Channel Filter -->
                    <div class="dropdown channel-filter-dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" id="channelFilter" data-bs-toggle="dropdown">
                            <i class="fas fa-filter"></i> 
                            {% if current_channel %}
                                {{ current_channel.channel_name }}
                            {% else %}
                                Tất cả kênh
                            {% endif %}
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/dashboard">
                                <i class="fas fa-th-large"></i> Tất cả kênh
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            {% for channel in all_channels.values() %}
                            <li><a class="dropdown-item" href="/dashboard?channel_id={{ channel.channel_id }}">
                                <i class="fas fa-tv"></i> {{ channel.channel_name }}
                            </a></li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                <div class="badge bg-primary fs-6">
                    <i class="fas fa-boxes"></i> 
                        {{ packages|length }} Package{{ 's' if packages|length != 1 else '' }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Channel Statistics -->
{% if channel_stats %}
<section class="py-3 bg-light">
    <div class="container">
        <div class="row">
            {% for channel_id, stats in channel_stats.items() %}
                         <div class="col-md-2 col-sm-4 col-6 mb-2">
                 <div class="card text-center h-100 channel-stats-card">
                     <div class="card-body py-2">
                        <div class="small text-muted">{{ all_channels[channel_id].channel_name if channel_id in all_channels else channel_id }}</div>
                        <div class="h5 mb-0 text-primary">{{ stats.total_packages }}</div>
                        <div class="small text-success">{{ stats.completed_packages }} hoàn thành</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Dashboard Actions -->
<section class="py-3 bg-secondary">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-success btn-sm" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    
                    <button class="btn btn-primary btn-sm" onclick="window.location.href='/'">
                        <i class="fas fa-plus"></i> Tạo Mới
                    </button>
                    
                    <div class="ms-auto">
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> 
                            Auto-refresh sau 30s
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Packages Grid -->
<section class="py-4">
    <div class="container">
        {% if packages %}
            {% if not current_channel %}
                <!-- Group by Channel when showing all -->
                {% set packages_by_channel = {} %}
                {% for package in packages %}
                    {% set channel_id = package.channel_id %}
                    {% if channel_id not in packages_by_channel %}
                        {% set _ = packages_by_channel.update({channel_id: []}) %}
                    {% endif %}
                    {% set _ = packages_by_channel[channel_id].append(package) %}
                {% endfor %}
                
                                 {% for channel_id, channel_packages in packages_by_channel.items() %}
                <div class="mb-5 channel-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="text-primary channel-header">
                            <i class="fas fa-tv"></i> 
                            {{ all_channels[channel_id].channel_name if channel_id in all_channels else channel_id }}
                            <span class="badge bg-secondary ms-2">{{ channel_packages|length }}</span>
                        </h4>
                        <a href="/dashboard?channel_id={{ channel_id }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> Xem tất cả
                        </a>
                    </div>
                    
                    <div class="row">
                        {% for package in channel_packages %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">
                                            <i class="fas fa-tv text-primary"></i> 
                                    {{ package.channel_name }}
                                </h6>
                                <small class="text-muted">{{ package.id }}</small>
                            </div>
                            <span class="badge status-badge status-{{ package.status }}">
                                {{ package.status.upper() }}
                            </span>
                        </div>
                        
                        <div class="card-body">
                            <!-- Thumbnail Preview -->
                            {% if package.input_data.video_frame_url %}
                            <div class="text-center mb-3 position-relative">
                                <img src="{{ package.input_data.video_frame_url }}" 
                                     alt="Reference Frame" 
                                     class="thumbnail-preview"
                                     title="Ảnh tham khảo">
                                <div class="position-absolute top-0 end-0 bg-info text-white px-1 rounded" 
                                     style="font-size: 0.7rem; margin: 2px;">
                                    <i class="fas fa-upload"></i> Ref
                                </div>
                            </div>
                            {% elif package.thumbnail_url %}
                            <div class="text-center mb-3 position-relative">
                                <img src="{{ package.thumbnail_url }}" 
                                     alt="Generated Thumbnail" 
                                     class="thumbnail-preview"
                                     title="Ảnh được tạo">
                                <div class="position-absolute top-0 end-0 bg-success text-white px-1 rounded" 
                                     style="font-size: 0.7rem; margin: 2px;">
                                    <i class="fas fa-magic"></i> AI
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center mb-3">
                                <div class="bg-dark rounded d-flex align-items-center justify-content-center" 
                                     style="height: 85px; max-width: 150px; margin: 0 auto;">
                                    <i class="fas fa-image fa-2x text-muted"></i>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Title -->
                            <h6 class="card-title">
                                {% if package.title and package.title != "Đang tạo..." %}
                                    {{ package.title[:60] }}...
                                {% else %}
                                    <span class="text-muted">
                                        {{ package.id }}
                                    </span>
                                {% endif %}
                            </h6>
                            
                            <!-- Timestamps -->
                            <div class="small text-muted mb-3">
                                <div>
                                    <i class="fas fa-calendar"></i> 
                                    {{ package.created_at }}
                                </div>
                            </div>
                            
                            <!-- Status Progress -->
                            <div class="mb-3">
                                {% set progress_map = {
                                    'pending': 0,
                                    'processing': 25,
                                    'generating_content': 50,
                                    'generated': 100,
                                    'failed': 0
                                } %}
                                {% set progress = progress_map.get(package.status, 0) %}
                                
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar progress-{{ progress }}
                                        {% if package.status == 'failed' %}bg-danger
                                        {% elif package.status == 'generated' %}bg-success
                                        {% else %}bg-primary{% endif %}">
                                    </div>
                                </div>
                                <small class="text-muted">
                                    {% if package.status == 'pending' %}
                                        Chờ xử lý
                                    {% elif package.status == 'processing' %}
                                        Đang xử lý...
                                    {% elif package.status == 'generating_content' %}
                                        Đang xử lý...
                                    {% elif package.status == 'generated' %}
                                        Hoàn thành
                                    {% elif package.status == 'failed' %}
                                        Thất bại
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        
                        <div class="card-footer">
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary flex-fill" 
                                        onclick="viewPackageDetails('{{ package.id }}')">
                                    <i class="fas fa-eye"></i> Chi tiết
                                </button>
                            </div>
                            
                            <!-- Recent Logs -->
                            {% if package.logs %}
                            <div class="mt-2">
                                <small class="text-muted">Logs gần nhất:</small>
                                <div class="mt-1" style="max-height: 60px; overflow-y: auto;">
                                    {% for log in package.logs[-2:] %}
                                    <div class="small text-muted">
                                        <i class="fas fa-chevron-right"></i> 
                                        {{ log.split(': ', 1)[1] if ': ' in log else log }}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- Single Channel View -->
                <div class="row">
                    {% for package in packages %}
                    <div class="col-lg-6 col-xl-4 mb-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0">
                                        <i class="fas fa-tv text-primary"></i> 
                                        {{ package.channel_name }}
                                    </h6>
                                    <small class="text-muted">{{ package.id }}</small>
                                </div>
                                <span class="badge status-badge status-{{ package.status }}">
                                    {{ package.status.upper() }}
                                </span>
                            </div>
                            
                            <div class="card-body">
                                <!-- Thumbnail Preview -->
                                {% if package.input_data.video_frame_url %}
                                <div class="text-center mb-3 position-relative">
                                    <img src="{{ package.input_data.video_frame_url }}" 
                                         alt="Reference Frame" 
                                         class="thumbnail-preview"
                                         title="Ảnh tham khảo">
                                    <div class="position-absolute top-0 end-0 bg-info text-white px-1 rounded" 
                                         style="font-size: 0.7rem; margin: 2px;">
                                        <i class="fas fa-upload"></i> Ref
                                    </div>
                                </div>
                                {% elif package.thumbnail_url %}
                                <div class="text-center mb-3 position-relative">
                                    <img src="{{ package.thumbnail_url }}" 
                                         alt="Generated Thumbnail" 
                                         class="thumbnail-preview"
                                         title="Ảnh được tạo">
                                    <div class="position-absolute top-0 end-0 bg-success text-white px-1 rounded" 
                                         style="font-size: 0.7rem; margin: 2px;">
                                        <i class="fas fa-magic"></i> AI
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center mb-3">
                                    <div class="bg-dark rounded d-flex align-items-center justify-content-center" 
                                         style="height: 85px; max-width: 150px; margin: 0 auto;">
                                        <i class="fas fa-image fa-2x text-muted"></i>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Title -->
                                <h6 class="card-title">
                                    {% if package.title and package.title != "Đang tạo..." %}
                                        {{ package.title[:60] }}...
                                    {% else %}
                                        <span class="text-muted">
                                            {{ package.id }}
                                        </span>
                                    {% endif %}
                                </h6>
                                
                                <!-- Timestamps -->
                                <div class="small text-muted mb-3">
                                    <div>
                                        <i class="fas fa-calendar"></i> 
                                        {{ package.created_at }}
                                    </div>
                                </div>
                                
                                <!-- Status Progress -->
                                <div class="mb-3">
                                    {% set progress_map = {
                                        'pending': 0,
                                        'processing': 25,
                                        'generating_content': 50,
                                        'generated': 100,
                                        'failed': 0
                                    } %}
                                    {% set progress = progress_map.get(package.status, 0) %}
                                    
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar progress-{{ progress }}
                                            {% if package.status == 'failed' %}bg-danger
                                            {% elif package.status == 'generated' %}bg-success
                                            {% else %}bg-primary{% endif %}">
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        {% if package.status == 'pending' %}
                                            Chờ xử lý
                                        {% elif package.status == 'processing' %}
                                            Đang xử lý...
                                        {% elif package.status == 'generating_content' %}
                                            Đang xử lý...
                                        {% elif package.status == 'generated' %}
                                            Hoàn thành
                                        {% elif package.status == 'failed' %}
                                            Thất bại
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                            
                            <div class="card-footer">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary flex-fill" 
                                            onclick="viewPackageDetails('{{ package.id }}')">
                                        <i class="fas fa-eye"></i> Chi tiết
                                    </button>
                                </div>
                                
                                <!-- Recent Logs -->
                                {% if package.logs %}
                                <div class="mt-2">
                                    <small class="text-muted">Logs gần nhất:</small>
                                    <div class="mt-1" style="max-height: 60px; overflow-y: auto;">
                                        {% for log in package.logs[-2:] %}
                                        <div class="small text-muted">
                                            <i class="fas fa-chevron-right"></i> 
                                            {{ log.split(': ', 1)[1] if ': ' in log else log }}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% else %}
            <!-- Empty State -->
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-inbox fa-4x text-muted"></i>
                </div>
                <h4 class="text-muted">
                    {% if current_channel %}
                        Chưa có nội dung nào cho {{ current_channel.channel_name }}
                    {% else %}
                        Chưa có nội dung nào
                    {% endif %}
                </h4>
                <p class="text-muted mb-4">
                    {% if current_channel %}
                        Bắt đầu tạo nội dung cho kênh {{ current_channel.channel_name }} ngay bây giờ!
                    {% else %}
                    Bắt đầu tạo nội dung YouTube đầu tiên của bạn ngay bây giờ!
                    {% endif %}
                </p>
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Tạo Nội Dung Mới
                </a>
            </div>
        {% endif %}
    </div>
</section>

<!-- Package Details Modal -->
<div class="modal fade" id="packageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-white">
            <div class="modal-header">
                <h5 class="modal-title text-dark">
                    <i class="fas fa-info-circle"></i> 
                    Chi Tiết Package
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="packageDetails">
                <div class="text-center">
                    <div class="loading-spinner"></div>
                    <p>Đang tải...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let packageModal;

document.addEventListener('DOMContentLoaded', function() {
    packageModal = new bootstrap.Modal(document.getElementById('packageModal'));
});

function refreshDashboard() {
    showAlert('Đang refresh dashboard...', 'info');
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

async function viewPackageDetails(packageId) {
    try {
        packageModal.show();
        
        const response = await fetch(`/api/package/${packageId}`);
        const package = await response.json();
        
        if (!response.ok) {
            throw new Error(package.detail || 'Lỗi khi tải package');
        }
        
        // Lưu thông tin thumbnail vào attributes
        const packageDetailsElement = document.getElementById('packageDetails');
        if (package.generated_images) {
            packageDetailsElement.setAttribute('data-current-thumbnail', package.generated_images.thumbnail_url || '');
            packageDetailsElement.setAttribute('data-selected-thumbnail', package.generated_images.selected_image_url || '');
        }
        
        // Render package details
        const detailsHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-dark"><i class="fas fa-info"></i> Thông Tin Cơ Bản</h6>
                    <table class="table table-bordered table-sm">
                        <tr>
                            <td>ID:</td>
                            <td><code>${package.id}</code></td>
                        </tr>
                        <tr>
                            <td>Kênh:</td>
                            <td>${package.input_data.channel_name}</td>
                        </tr>
                        <tr>
                            <td>Trạng thái:</td>
                            <td><span class="badge status-${package.status}">${package.status.toUpperCase()}</span></td>
                        </tr>
                        <tr>
                            <td>Tạo lúc:</td>
                            <td>${new Date(package.created_at).toLocaleString('vi-VN')}</td>
                        </tr>
                        <tr>
                            <td>Cập nhật:</td>
                            <td>${new Date(package.updated_at).toLocaleString('vi-VN')}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="col-md-6">
                    <h6 class="text-dark"><i class="fas fa-image"></i> Thumbnail</h6>
                    <div id="thumbnailPreviewArea" class="thumbnail-preview-area mb-3">
                        ${package.generated_images && package.generated_images.thumbnail_url ? `
                            <img id="mainThumbnailImage" src="${package.generated_images.thumbnail_url}" 
                                 class="img-fluid rounded" 
                                 style="max-height: 200px; width: 100%; object-fit: cover;">
                            <div class="text-center mt-2">
                                <small class="text-muted">Thumbnail hiện tại</small>
                            </div>
                        ` : `
                            <div class="thumbnail-placeholder d-flex align-items-center justify-content-center bg-light rounded" 
                                 style="height: 200px; border: 2px dashed #ccc;">
                                <div class="text-center">
                                    <i class="fas fa-image fa-3x text-muted mb-2"></i>
                                    <div class="text-muted">Di chuột vào ảnh bên dưới để xem preview</div>
                                </div>
                            </div>
                        `}
                    </div>
                    
                    ${package.generated_images ? `
                        <div class="mb-3">
                            <p class="mb-1"><strong>Số ảnh từ Midjourney:</strong> 
                                <span class="badge bg-primary">${package.generated_images.midjourney_urls ? package.generated_images.midjourney_urls.length : 0}</span>
                            </p>
                            <p class="mb-1"><strong>Ảnh bổ sung:</strong> 
                                <span class="badge bg-secondary">${package.generated_images.additional_images ? package.generated_images.additional_images.length : 0}</span>
                            </p>
                            ${package.generated_images.selected_image_url ? `
                                <p class="mb-1"><strong>Trạng thái:</strong> 
                                    <span class="badge bg-success"><i class="fas fa-check"></i> Đã chọn thumbnail</span>
                                </p>
                            ` : `
                                <p class="mb-1"><strong>Trạng thái:</strong> 
                                    <span class="badge bg-warning"><i class="fas fa-clock"></i> Chưa chọn thumbnail</span>
                                </p>
                            `}
                        </div>
                    ` : ''}
                </div>
            </div>
            
            ${package.generated_images && package.generated_images.midjourney_urls && package.generated_images.midjourney_urls.length > 0 ? `
                <div class="mt-4">
                    <h6 class="text-dark"><i class="fas fa-images"></i> Chọn Ảnh Thumbnail (${package.generated_images.midjourney_urls.length} ảnh)</h6>
                    <div class="row">
                        ${package.generated_images.midjourney_urls.map((url, index) => `
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card image-selection-card ${package.generated_images.selected_image_url === url ? 'selected' : ''}" 
                                     onmouseenter="showImagePreview('${url}', 'Ảnh ${index + 1}')"
                                     onmouseleave="hideImagePreview()">
                                    <img src="${url}" class="card-img-top" style="height: 150px; object-fit: cover;">
                                    <div class="card-body p-2 text-center">
                                        <small class="text-muted">Ảnh ${index + 1}</small>
                                        ${package.generated_images.selected_image_url === url ? 
                                            '<i class="fas fa-check-circle text-success"></i>' : 
                                            '<i class="fas fa-circle text-muted"></i>'
                                        }
                                    </div>
                                    <button class="image-select-btn ${package.generated_images.selected_image_url === url ? 'selected' : ''}" 
                                            onclick="selectImageNew('${package.id}', '${url}', this, event)">
                                        ${package.generated_images.selected_image_url === url ? 
                                            '<i class="fas fa-check me-1"></i>Đã chọn' : 
                                            '<i class="fas fa-mouse-pointer me-1"></i>Chọn'
                                        }
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${package.generated_images.selected_image_url ? `
                        <div class="alert alert-success mt-2">
                            <i class="fas fa-check"></i> Đã chọn ảnh: ${package.generated_images.selected_image_url}
                        </div>
                    ` : `
                        <div class="alert alert-info mt-2">
                            <i class="fas fa-info-circle"></i> Di chuột vào ảnh để xem preview, nhấn nút "Chọn" để chọn làm thumbnail chính
                        </div>
                    `}
                </div>
            ` : ''}
            

            
            ${package.generated_content ? `
                <div class="mt-4">
                    <h6 class="text-dark"><i class="fas fa-file-text"></i> Nội Dung Đã Tạo</h6>
                    <div class="card border">
                        <div class="card-body">
                            <h6 class="text-dark">Tiêu đề:</h6>
                            <p class="text-primary">${package.generated_content.title}</p>
                            
                            <h6 class="text-dark">Mô tả:</h6>
                            <p class="small">${package.generated_content.description.substring(0, 200)}...</p>
                            
                            <h6 class="text-dark">Tags:</h6>
                            <div class="d-flex flex-wrap gap-1">
                                ${package.generated_content.tags.map(tag => 
                                    `<span class="badge bg-primary">${tag}</span>`
                                ).join('')}
                            </div>
                            
                            <h6 class="mt-3 text-dark">Tên Thumbnail:</h6>
                            <p>${package.generated_content.thumbnail_name}</p>
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <div class="mt-4">
                <h6 class="text-dark"><i class="fas fa-list"></i> Processing Logs</h6>
                <div class="bg-light rounded p-3 border" style="max-height: 200px; overflow-y: auto;">
                    ${package.processing_logs.map(log => 
                        `<div class="small text-secondary mb-1">${log}</div>`
                    ).join('')}
                </div>
            </div>
        `;
        
        document.getElementById('packageDetails').innerHTML = detailsHtml;
        
    } catch (error) {
        document.getElementById('packageDetails').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> 
                Lỗi khi tải chi tiết: ${error.message}
            </div>
        `;
    }
}



async function selectImage(packageId, imageUrl, cardElement) {
    try {
        // Hiển thị loading
        const originalContent = cardElement.innerHTML;
        cardElement.innerHTML = `
            <div class="text-center p-3">
                <div class="loading-spinner mb-2"></div>
                <small>Đang cập nhật...</small>
            </div>
        `;
        
        // Gọi API để cập nhật ảnh được chọn
        const response = await fetch(`/api/packages/${packageId}/select-image`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                selected_image_url: imageUrl
            })
        });
        
        if (!response.ok) {
            throw new Error('Lỗi khi cập nhật ảnh');
        }
        
        const result = await response.json();
        
        // Cập nhật UI
        document.querySelectorAll('.image-selection-card').forEach(card => {
            card.classList.remove('selected');
            const icon = card.querySelector('i');
            if (icon) {
                icon.className = 'fas fa-circle text-muted';
            }
        });
        
        // Đánh dấu ảnh được chọn
        cardElement.classList.add('selected');
        const icon = cardElement.querySelector('i');
        if (icon) {
            icon.className = 'fas fa-check-circle text-success';
        }
        
        // Khôi phục nội dung card
        cardElement.innerHTML = originalContent;
        cardElement.classList.add('selected');
        
        // Cập nhật alert
        const alertContainer = document.querySelector('.alert');
        if (alertContainer) {
            alertContainer.className = 'alert alert-success mt-2';
            alertContainer.innerHTML = `
                <i class="fas fa-check"></i> Đã chọn ảnh: ${imageUrl}
            `;
        }
        
        showAlert('Đã cập nhật ảnh được chọn thành công!', 'success');
        
    } catch (error) {
        // Khôi phục nội dung card nếu có lỗi
        cardElement.innerHTML = originalContent;
        showAlert('Lỗi khi cập nhật ảnh: ' + error.message, 'danger');
    }
}

// Hàm mới để chọn ảnh với nút bấm
async function selectImageNew(packageId, imageUrl, buttonElement, event) {
    event.stopPropagation(); // Ngăn sự kiện click lan truyền
    
    try {
        // Hiển thị loading trên nút
        const originalContent = buttonElement.innerHTML;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang chọn...';
        buttonElement.disabled = true;
        
        // Gọi API để cập nhật ảnh được chọn
        const response = await fetch(`/api/packages/${packageId}/select-image`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                selected_image_url: imageUrl
            })
        });
        
        if (!response.ok) {
            throw new Error('Lỗi khi cập nhật ảnh');
        }
        
        const result = await response.json();
        
        // Cập nhật UI - remove selected từ tất cả buttons
        document.querySelectorAll('.image-select-btn').forEach(btn => {
            btn.classList.remove('selected');
            btn.innerHTML = '<i class="fas fa-mouse-pointer me-1"></i>Chọn';
        });
        
        // Remove selected từ tất cả cards
        document.querySelectorAll('.image-selection-card').forEach(card => {
            card.classList.remove('selected');
            const icon = card.querySelector('.card-body i');
            if (icon) {
                icon.className = 'fas fa-circle text-muted';
            }
        });
        
        // Đánh dấu button và card được chọn
        buttonElement.classList.add('selected');
        buttonElement.innerHTML = '<i class="fas fa-check me-1"></i>Đã chọn';
        buttonElement.disabled = false;
        
        // Đánh dấu card được chọn
        const cardElement = buttonElement.closest('.image-selection-card');
        cardElement.classList.add('selected');
        const icon = cardElement.querySelector('.card-body i');
        if (icon) {
            icon.className = 'fas fa-check-circle text-success';
        }
        
        // Cập nhật thumbnail area với ảnh mới được chọn
        const thumbnailArea = document.getElementById('thumbnailPreviewArea');
        if (thumbnailArea) {
            thumbnailArea.innerHTML = `
                <img src="${imageUrl}" 
                     class="img-fluid rounded" 
                     style="max-height: 200px; width: 100%; object-fit: cover; border: 2px solid var(--accent-color);">
                <div class="text-center mt-2">
                    <small class="text-success font-weight-bold">
                        <i class="fas fa-check-circle me-1"></i>Thumbnail đã chọn
                    </small>
                </div>
            `;
            
            // Cập nhật attribute để lưu ảnh đã chọn
            const packageDetails = document.getElementById('packageDetails');
            if (packageDetails) {
                packageDetails.setAttribute('data-selected-thumbnail', imageUrl);
            }
        }
        
        // Cập nhật alert
        const alertContainer = document.querySelector('.alert');
        if (alertContainer) {
            alertContainer.className = 'alert alert-success mt-2';
            alertContainer.innerHTML = `
                <i class="fas fa-check"></i> Đã chọn ảnh thành công! Bạn có thể chọn lại bất cứ lúc nào.
            `;
        }
        
        showAlert('Đã cập nhật ảnh được chọn thành công!', 'success');
        
    } catch (error) {
        // Khôi phục nút nếu có lỗi
        buttonElement.innerHTML = originalContent;
        buttonElement.disabled = false;
        showAlert('Lỗi khi cập nhật ảnh: ' + error.message, 'danger');
    }
}

// Hàm hiển thị preview ảnh trong vùng thumbnail
function showImagePreview(imageUrl, title) {
    const thumbnailArea = document.getElementById('thumbnailPreviewArea');
    if (!thumbnailArea) return;
    
    // Cập nhật vùng thumbnail với ảnh preview
    thumbnailArea.innerHTML = `
        <img src="${imageUrl}" 
             class="img-fluid rounded preview-image" 
             style="max-height: 200px; width: 100%; object-fit: cover; border: 3px solid var(--primary-color); transition: all 0.3s ease;">
        <div class="text-center mt-2">
            <small class="text-primary font-weight-bold">
                <i class="fas fa-eye me-1"></i>Preview: ${title}
            </small>
        </div>
    `;
    
    // Thêm animation
    const previewImg = thumbnailArea.querySelector('.preview-image');
    if (previewImg) {
        previewImg.style.transform = 'scale(0.95)';
        setTimeout(() => {
            previewImg.style.transform = 'scale(1)';
        }, 100);
    }
}

// Hàm ẩn preview ảnh - trở về thumbnail gốc
function hideImagePreview() {
    const thumbnailArea = document.getElementById('thumbnailPreviewArea');
    if (!thumbnailArea) return;
    
    // Lấy thông tin package hiện tại từ modal
    const packageDetails = document.getElementById('packageDetails');
    if (!packageDetails) return;
    
    // Tìm ảnh thumbnail gốc từ dữ liệu package
    const currentThumbnail = packageDetails.getAttribute('data-current-thumbnail');
    const currentSelected = packageDetails.getAttribute('data-selected-thumbnail');
    
    // Khôi phục về ảnh thumbnail gốc hoặc placeholder
    if (currentSelected || currentThumbnail) {
        const thumbnailUrl = currentSelected || currentThumbnail;
        thumbnailArea.innerHTML = `
            <img src="${thumbnailUrl}" 
                 class="img-fluid rounded" 
                 style="max-height: 200px; width: 100%; object-fit: cover; transition: all 0.3s ease;">
            <div class="text-center mt-2">
                <small class="text-muted">
                    ${currentSelected ? 'Thumbnail đã chọn' : 'Thumbnail hiện tại'}
                </small>
            </div>
        `;
    } else {
        thumbnailArea.innerHTML = `
            <div class="thumbnail-placeholder d-flex align-items-center justify-content-center bg-light rounded" 
                 style="height: 200px; border: 2px dashed #ccc;">
                <div class="text-center">
                    <i class="fas fa-image fa-3x text-muted mb-2"></i>
                    <div class="text-muted">Di chuột vào ảnh bên dưới để xem preview</div>
                </div>
            </div>
        `;
    }
}

// Status color mapping
const statusColors = {
    'pending': 'warning',
    'processing': 'primary', 
    'generated': 'success',
    'failed': 'danger'
};

// Auto refresh dashboard every 30 seconds (defined in base template)
// Page reload sẽ được thực hiện tự động
</script>
{% endblock %} 